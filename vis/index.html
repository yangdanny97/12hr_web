<html>
<script src="https://d3js.org/d3.v5.min.js"></script>
<style>
    @keyframes pulse {
        0% {
            stroke-width: 1px;
        }
        50% {
            stroke-width: 10px;
        }
        100% {
            stroke-width: 1px;
        }
    }
    .pulse {
        animation: pulse 3s linear infinite;
    }

    .hidden {
        opacity: 0.2;
        transition: opacity 1s;
    }
</style>

<body>
</body>
<script>
    let nodes = [{
            "key": "",
            "id": "Mind Map",
            "url": "Mind_Map",
            "brush": "silver"
        },
        {
            "key": 1,
            "parent": 0,
            "id": "Getting more time",
            "url": "Getting_more_time",
            "brush": "skyblue",
        },
        {
            "key": 11,
            "parent": 1,
            "id": "Wake up early",
            "url": "Wake_up_early",
            "brush": "skyblue",
        },
        {
            "key": 12,
            "parent": 1,
            "id": "Delegate",
            "url": "Delegate",
            "brush": "skyblue",
        },
        {
            "key": 13,
            "parent": 1,
            "id": "Simplify",
            "url": "Simplify",
            "brush": "skyblue",
        },
        {
            "key": 2,
            "parent": 0,
            "id": "More effective use",
            "url": "More_effective_use",
            "brush": "darkseagreen",
        },
        {
            "key": 21,
            "parent": 2,
            "id": "Planning",
            "url": "Planning",
            "brush": "darkseagreen",
        },
        {
            "key": 211,
            "parent": 21,
            "id": "Priorities",
            "url": "Priorities",
            "brush": "darkseagreen",
        },
        {
            "key": 212,
            "parent": 21,
            "id": "Ways to focus",
            "url": "Ways_to_focus",
            "brush": "darkseagreen",
        },
        {
            "key": 22,
            "parent": 2,
            "id": "Goals",
            "url": "Goals",
            "brush": "darkseagreen",
        },
        {
            "key": 3,
            "parent": 0,
            "id": "Time wasting",
            "url": "Time_wasting",
            "brush": "palevioletred",
        },
        {
            "key": 31,
            "parent": 3,
            "id": "Too many meetings",
            "url": "Too_many_meetings",
            "brush": "palevioletred",
        },
        {
            "key": 32,
            "parent": 3,
            "id": "Too much time spent on details",
            "url": "Too_much_time_spent_on_details",
            "brush": "palevioletred",
        },
        {
            "key": 33,
            "parent": 3,
            "id": "Message fatigue",
            "url": "Message_fatigue",
            "brush": "palevioletred",
        },
        {
            "key": 331,
            "parent": 31,
            "id": "Check messages less",
            "url": "Check_messages_less",
            "brush": "palevioletred",
        },
        {
            "key": 332,
            "parent": 31,
            "id": "Message filters",
            "url": "Message_filters",
            "brush": "palevioletred",
        },
        {
            "key": 4,
            "parent": 0,
            "id": "Key issues",
            "url": "Key_issues",
            "brush": "coral",
        },
        {
            "key": 41,
            "parent": 4,
            "id": "Methods",
            "url": "Methods",
            "brush": "coral",
        },
        {
            "key": 42,
            "parent": 4,
            "id": "Deadlines",
            "url": "Deadlines",
            "brush": "coral",
        },
        {
            "key": 43,
            "parent": 4,
            "id": "Checkpoints",
            "url": "Checkpoints",
            "brush": "coral",
        }
    ];

    nodes.forEach((d) => d.depth = d.key.toString().length);

    let links = [];
    nodes.forEach(function (d) {
        if (d.hasOwnProperty('parent')) {
            links.push({
                "source": nodes.find((x) => x.key == d.parent).id,
                "target": d.id,
            });
        }
    });

    var width = window.innerWidth,
        height = window.innerHeight;
    var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);
    var background = svg.append("rect")
        .attr("id", "back")
        .attr("width", width)
        .attr("height", height)
        .attr("stroke", "black")
        .attr("fill", "steelblue");
    var zoomable_layer = svg.append("g");
    var offsetX, offsetY, zoomLevel;

    function reset(){
        var x = width/2,
        y = height/2,
        k = 0.5;
        d3.selectAll(".nodes").classed("hidden", false);
        zoomable_layer.transition()
            .duration(1000)
            .style("transform", "matrix("+k+",0,0,"+k+","+(-x)*(k-1)+","+(-y)*(k-1)+")");
    }

    svg.on("click", reset);

    var maxNodeSize = 120;

    var widthScale = d3.scaleLinear().domain([0, 5]).range([maxNodeSize, maxNodeSize/5]);

    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id((d) => d.id)
            .strength(1)
            .distance((d) => 30)//widthScale(d.source.depth) + widthScale(d.target.depth) - 25)
        )
        .force("charge", d3.forceManyBody().strength(-6000))
        .force("centerX", d3.forceX(width / 2)
            .strength((d) => (d.hasOwnProperty('parent')) ? 0.1: 1)
        )
        .force("centerY", d3.forceY(height / 2)
            .strength((d) => (d.hasOwnProperty('parent')) ? 0.1: 1)
        )
        .force("collide", d3.forceCollide()
            .radius((d) => 5 + widthScale(d.depth))
        )
        .stop();

    var link = zoomable_layer.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("stroke", "silver")
        .attr("class", "links")
        .attr("stroke-width", 1);

    var node = zoomable_layer.append("g")
        .selectAll("g")
        .data(nodes)
        .enter().append("g")
        .attr("class", "nodes")
        .attr("id", (d) => d.url);

    var circles = node.append("circle")
        .attr("fill", (d) => d.brush)
        .attr("r", (d) => widthScale(d.depth))
        .attr("stroke",(d) => d.brush)
        .attr("class", "pulse");

    var labels = node.append("text")
        .text((d) => d.id)
        .attr('text-anchor', "middle")
        .attr('x', 0)
        .attr('y', 0)
        .style("opacity", 1);

    simulation.nodes(nodes);
    simulation.force("link")
        .links(links);

    for (var i = 0; i < 600; ++i) simulation.tick();

    link.attr("x1", function (d) {
            return d.source.x;
        })
        .attr("y1", function (d) {
            return d.source.y;
        })
        .attr("x2", function (d) {
            return d.target.x;
        })
        .attr("y2", function (d) {
            return d.target.y;
        });

    node.attr("transform", function (d) {
        return "translate(" + d.x + "," + d.y + ")";
    });

    node.on('click', function (d) {
        console.log(d3.select(".nodes"));
        d3.selectAll(".nodes").classed("hidden", false);
        d3.event.stopPropagation();
        var x = d.x,
            y = d.y,
            k = maxNodeSize/widthScale(d.depth) * 2;

        zoomable_layer.transition()
        .duration(1000)
        .style("transform", "matrix("+k+",0,0,"+k+","+(-x * (k-1) + (width/2 - x))+","+(-y* (k-1) + (height/2 - y))+")");
        d3.select("#"+d.url).classed("hidden", true);
    });

    let url = window.location.href;
    if (url.lastIndexOf("#") >= 0){
        let element_id = url.substring(url.lastIndexOf('#'));
        d3.select(element_id).dispatch('click');
    }
</script>
</html>